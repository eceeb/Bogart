var http      = require('http')
var app       = require('../app')
var mail      = require('../libs/mail')
var search    = require('../libs/search/search')
var website   = require('../libs/website')
var database  = require('../libs/database')


app.set('port', process.env.PORT)

var searchInterval = process.argv[2]
console.log('Starting search for ' + searchInterval + ' minutes interval...')

var whenSelected = function (doc) {

    // for future features the query will return also found elements
    if (doc.found) return

    var whenLoaded = function (body) {
        doc.found = search.after(doc, body)
        if (doc.found) {
            mail.send(doc)
            database.update(doc)
        }
    }

    website.load(doc.url, whenLoaded)
}

database.select(searchInterval, whenSelected)
